package com.shiro.springboot_jsp_shiro.controller;import com.shiro.springboot_jsp_shiro.entity.User;import com.shiro.springboot_jsp_shiro.service.UserService;import com.shiro.springboot_jsp_shiro.utils.VerifyCodeUtils;import org.apache.shiro.SecurityUtils;import org.apache.shiro.authc.IncorrectCredentialsException;import org.apache.shiro.authc.UnknownAccountException;import org.apache.shiro.authc.UsernamePasswordToken;import org.apache.shiro.subject.Subject;import org.springframework.beans.factory.annotation.Autowired;import org.springframework.stereotype.Controller;import org.springframework.web.bind.annotation.RequestMapping;import javax.servlet.ServletOutputStream;import javax.servlet.http.HttpServletResponse;import javax.servlet.http.HttpSession;import java.io.IOException;@Controller@RequestMapping("user")public class UserController {    @RequestMapping("login")    public String login(String username,String password,String code,HttpSession session){        //验证码对比(验证码后面放在Redis中实现,因为session不支持微服务)        if (!session.getAttribute("code").toString().equalsIgnoreCase(code)){            throw new RuntimeException("验证码错误");        }        //获取主体对象        Subject subject = SecurityUtils.getSubject();        try {            subject.login(new UsernamePasswordToken(username,password));            return "redirect:/index.jsp";        }catch (UnknownAccountException e){            e.printStackTrace();            System.out.println("用户名错误");        }catch (IncorrectCredentialsException e){            e.printStackTrace();            System.out.println("密码错误");        }        return "redirect:/login.jsp";    }    @RequestMapping("logout")    public String logout(){        Subject subject = SecurityUtils.getSubject();        subject.logout();        return "redirect:/login.jsp";    }    @Autowired    private UserService userService;    @RequestMapping("register")    public String register(User user){        try {            userService.register(user);            return "redirect:/login.jsp";        }catch (Exception e){            e.printStackTrace();            return "redirect:/register.jsp";        }    }    @RequestMapping("getImage")    public void getImage(HttpSession session, HttpServletResponse response) throws IOException {        //生成验证码        String code = VerifyCodeUtils.generateVerifyCode(4);        //验证码放入session        session.setAttribute("code",code);        //验证码存入图片        ServletOutputStream os = response.getOutputStream();        response.setContentType("image/png");        VerifyCodeUtils.outputImage(220,60,os,code);    }}